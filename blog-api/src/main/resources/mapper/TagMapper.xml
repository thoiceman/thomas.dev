<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xu.blogapi.mapper.TagMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.xu.blogapi.model.entity.Tag">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="slug" column="slug" jdbcType="VARCHAR"/>
        <result property="color" column="color" jdbcType="VARCHAR"/>
        <result property="useCount" column="use_count" jdbcType="INTEGER"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="isDelete" column="is_delete" jdbcType="TINYINT"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, name, slug, color, use_count, create_time, update_time, is_delete
    </sql>

    <!-- 根据条件查询标签列表（支持模糊搜索和排序） -->
    <select id="selectTagsByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM tag
        WHERE is_delete = 0
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="slug != null and slug != ''">
            AND slug = #{slug}
        </if>
        <if test="searchText != null and searchText != ''">
            AND name LIKE CONCAT('%', #{searchText}, '%')
        </if>
        <choose>
            <when test="sortField != null and sortField != ''">
                ORDER BY
                <choose>
                    <when test="sortField == 'name'">name</when>
                    <when test="sortField == 'slug'">slug</when>
                    <when test="sortField == 'use_count'">use_count</when>
                    <when test="sortField == 'create_time'">create_time</when>
                    <when test="sortField == 'update_time'">update_time</when>
                    <otherwise>create_time</otherwise>
                </choose>
                <choose>
                    <when test="sortOrder != null and sortOrder.toLowerCase() == 'desc'">DESC</when>
                    <otherwise>ASC</otherwise>
                </choose>
            </when>
            <otherwise>
                ORDER BY use_count DESC, create_time DESC
            </otherwise>
        </choose>
    </select>

    <!-- 检查标签别名是否存在 -->
    <select id="existsBySlug" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM tag
        WHERE slug = #{slug}
        AND is_delete = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查标签名称是否存在 -->
    <select id="existsByName" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM tag
        WHERE name = #{name}
        AND is_delete = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 批量增加标签使用次数 -->
    <update id="batchIncrementUseCount">
        UPDATE tag 
        SET use_count = use_count + 1, update_time = NOW()
        WHERE id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        AND is_delete = 0
    </update>

    <!-- 批量减少标签使用次数 -->
    <update id="batchDecrementUseCount">
        UPDATE tag 
        SET use_count = GREATEST(use_count - 1, 0), update_time = NOW()
        WHERE id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        AND is_delete = 0
    </update>

    <!-- 根据文章ID查询关联的标签 -->
    <select id="selectTagsByArticleId" resultMap="BaseResultMap">
        SELECT t.<include refid="Base_Column_List"/>
        FROM tag t
        INNER JOIN article_tag at ON t.id = at.tag_id
        WHERE at.article_id = #{articleId}
        AND t.is_delete = 0
        ORDER BY t.use_count DESC, t.create_time ASC
    </select>

</mapper>